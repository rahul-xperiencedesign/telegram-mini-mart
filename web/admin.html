<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · South Asia Mart</title>
  <style>
    :root{--bg:#0b1220;--panel:#121a2a;--muted:#8aa0c8;--text:#e7eefc;--accent:#3b82f6;--danger:#ef4444;--ok:#10b981}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1180px;margin:30px auto;padding:0 16px}
    h1{font-size:18px;margin:0 0 18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 14px;cursor:pointer}
    .btn.small{padding:6px 10px;font-size:12px}
    .btn.ghost{background:#26334e}
    .btn.danger{background:var(--danger)}
    .grid{display:grid;grid-template-columns:1.4fr .9fr;gap:16px}
    .card{background:var(--panel);border:1px solid #1f2a44;border-radius:12px;padding:14px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2a44;padding:10px;vertical-align:top}
    th{color:var(--muted);font-weight:600;text-align:left}
    input,select{width:100%;background:#0e1626;border:1px solid #1e2a45;border-radius:8px;color:var(--text);padding:9px}
    input::placeholder{color:#6f84b0}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .section-title{color:var(--muted);margin:8px 0 10px;font-weight:600}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #1f2a44}
    .pill.ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
    .pill.warn{background:rgba(234,179,8,.12);border-color:rgba(234,179,8,.35)}
    .pill.muted{background:#0e1626;border-color:#243250;color:#a7b8df}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .spacer{height:10px}
    .hint{font-size:12px;color:#9db2dc}
    @media (max-width:950px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Admin</h1>
      <div class="row" style="flex:0 0 auto;gap:8px">
        <button id="btnLogout" class="btn ghost small">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Orders -->
      <div class="card">
        <div class="row" style="gap:8px; margin-bottom:10px">
          <strong style="flex:0 0 auto">Orders</strong>
          <select id="filterStatus" style="flex:0 0 160px">
            <option value="">All</option>
            <option>placed</option>
            <option>paid</option>
            <option>shipped</option>
            <option>delivered</option>
            <option>cancelled</option>
          </select>
          <input id="filterQ" placeholder="Search name/phone/address" />
          <button id="btnRefresh" class="btn small" style="flex:0 0 auto">Refresh</button>
        </div>

        <table id="ordersTable">
          <thead>
            <tr>
              <th style="width:80px">ID</th>
              <th>Customer</th>
              <th class="right" style="width:120px">Total</th>
              <th style="width:140px">Status</th>
              <th style="width:160px">When</th>
              <th style="width:120px">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- RIGHT: Stats + Product editor -->
      <div class="card">
        <div class="section-title">Quick Stats</div>
        <div id="statsBox" class="muted" style="margin-bottom:14px">Loading…</div>

        <div class="section-title">Add / Update Product</div>
        <div class="row">
          <input id="p_id" placeholder="SKU e.g. RICE5" />
        </div>
        <div class="row">
          <input id="p_title" placeholder="Product title" />
        </div>
        <div class="row">
          <input id="p_price" placeholder="Price (₹ in paise, e.g. 89900)" />
        </div>
        <div class="row">
          <input id="p_category" placeholder="Category e.g. Rice & Grains" />
        </div>
        <div class="row">
          <input id="p_image" placeholder="Image URL (optional)" />
        </div>
        <div class="row" style="gap:8px">
          <label style="flex:1 1 auto">
            <input type="checkbox" id="p_restricted" /> Age-restricted
          </label>
          <input id="p_stock" placeholder="Stock e.g. 1000" />
        </div>
        <div class="row" style="gap:8px;margin-top:10px">
          <button id="btnSave" class="btn">Save</button>
          <button id="btnDelete" class="btn danger">Delete</button>
        </div>

        <div class="spacer"></div>
        <div class="hint">Optional upload (requires Cloudinary + <code>/admin/upload</code>):</div>
        <input type="file" id="fileUp" accept="image/*" />
        <button id="btnUpload" class="btn small" style="margin-top:6px">Upload → set Image URL</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * API + Auth bootstrap
     ***********************/
    // 1) Your Render backend (NO trailing slash)
    const API_BASE = 'https://telegram-mini-mart.onrender.com';

    // 2) Patch fetch: prefix relative URLs & attach Authorization
    const __fetch = window.fetch.bind(window);
    window.fetch = (input, init = {}) => {
      let url = input;
      if (typeof input === 'string' && input.startsWith('/')) {
        url = API_BASE + input;
      }
      const headers = new Headers(init.headers || {});
      const token = localStorage.getItem('adminToken');
      if (token && !headers.has('Authorization')) {
        headers.set('Authorization', 'Bearer ' + token);
      }
      return __fetch(url, { ...init, headers });
    };

    // 3) Guard: if not logged in / token bad → go to login
    async function guard() {
      const t = localStorage.getItem('adminToken');
      if (!t) return goLogin();
      try {
        const r = await fetch('/admin/auth/session');
        if (!r.ok) throw 0;
        const js = await r.json().catch(() => ({}));
        if (!js.ok) throw 0;
      } catch {
        localStorage.removeItem('adminToken');
        return goLogin();
      }
    }
    function goLogin() {
      // Keep nice return flow after login
      location.href = '/admin-login.html';
    }

    /***********************
     * Small helpers
     ***********************/
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const fmtINR = (paisa) => '₹ ' + (Math.round(+paisa)/100).toFixed(2);

    function el(tag, props={}, ...kids){
      const n = Object.assign(document.createElement(tag), props);
      for (const k of kids) n.append(k);
      return n;
    }

    /***********************
     * Stats
     ***********************/
    async function loadStats(){
      const box = $('#statsBox');
      box.textContent = 'Loading…';
      const r = await fetch('/admin/stats');
      const js = await r.json();
      if (!r.ok || !js.ok) {
        box.textContent = 'Failed to load stats';
        return;
      }
      const lines = [
        `Products: ${js.product_count}`,
        `Revenue: ${fmtINR(js.revenue)}`,
        '',
        'Last 7 days:',
        ...js.last7.map(d => `• ${d.day}: ${d.orders} orders / ${fmtINR(d.revenue)}`)
      ];
      box.innerHTML = lines.join('<br>');
    }

    /***********************
     * Orders
     ***********************/
    let currentPage = 1;
    async function loadOrders(){
      const status = $('#filterStatus').value;
      const q = $('#filterQ').value.trim();
      const url = new URL('/admin/orders', API_BASE);
      if (status) url.searchParams.set('status', status);
      if (q) url.searchParams.set('q', q);
      url.searchParams.set('page', currentPage);
      url.searchParams.set('pageSize', 50);

      const r = await fetch(url.pathname + url.search);
      const js = await r.json();
      const tbody = $('#ordersTable tbody');
      tbody.innerHTML = '';
      if (!r.ok || !js.ok || !js.items?.length){
        tbody.append(el('tr', {}, el('td', { colSpan: 6, className:'muted', textContent: 'No orders found.' })));
        return;
      }
      for (const o of js.items){
        const sel = el('select', { value: o.status });
        ['placed','paid','shipped','delivered','cancelled'].forEach(s=>{
          sel.append(el('option', { value:s, textContent:s }));
        });

        const btn = el('button', { className:'btn small', textContent:'Update' });
        btn.onclick = async () => {
          btn.disabled = true;
          const rr = await fetch(`/admin/orders/${o.id}/status`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ status: sel.value })
          });
          btn.disabled = false;
          if (rr.ok) loadOrders();
          else alert('Failed to update status');
        };

        const tr = el('tr', {},
          el('td', {}, '#'+o.id),
          el('td', {}, el('div',{}, o.name||'—'), el('div',{className:'muted'}, (o.phone||'')+' · '+(o.address||''))),
          el('td', { className:'right' }, fmtINR(o.total)),
          el('td', {}, sel),
          el('td', {}, new Date(o.created_at).toLocaleString()),
          el('td', {}, btn),
        );
        tbody.append(tr);
      }
    }

    /***********************
     * Products (CRUD)
     ***********************/
    async function onSaveProduct(){
      const body = {
        id: $('#p_id').value.trim(),
        title: $('#p_title').value.trim(),
        price: +$('#p_price').value.trim() || 0,
        category: $('#p_category').value.trim(),
        image: $('#p_image').value.trim(),
        age_restricted: $('#p_restricted').checked,
        stock: +$('#p_stock').value.trim() || 0,
      };
      if (!body.id || !body.title || !body.category) {
        return alert('Please fill SKU, Title and Category.');
      }
      const r = await fetch('/admin/products', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if (!r.ok) return alert('Save failed');
      await loadStats();
      alert('Saved ✓');
    }

    async function onDeleteProduct(){
      const id = $('#p_id').value.trim();
      if (!id) return alert('Enter SKU to delete');
      if (!confirm(`Delete product ${id}?`)) return;
      const r = await fetch('/admin/products/'+encodeURIComponent(id), { method:'DELETE' });
      if (!r.ok) return alert('Delete failed');
      await loadStats();
      alert('Deleted ✓');
    }

    /***********************
     * Optional: image upload
     ***********************/
    async function onUpload(){
      const f = $('#fileUp').files?.[0];
      if (!f) return alert('Choose a file first');
      const fd = new FormData();
      fd.append('file', f);
      const r = await fetch('/admin/upload', { method:'POST', body: fd });
      const js = await r.json().catch(()=>({}));
      if (!r.ok || !js.ok) return alert('Upload failed (check Cloudinary settings)');
      $('#p_image').value = js.url || '';
      alert('Uploaded ✓ — URL set in Image field');
    }

    /***********************
     * Wiring
     ***********************/
    (async function init(){
      await guard();               // redirect to login if not authenticated
      await loadStats();
      await loadOrders();

      $('#btnRefresh').onclick = ()=>{ currentPage=1; loadOrders(); };
      $('#filterStatus').onchange = ()=>{ currentPage=1; loadOrders(); };
      $('#filterQ').onkeydown = (e)=>{ if (e.key==='Enter') { currentPage=1; loadOrders(); } };

      $('#btnSave').onclick = onSaveProduct;
      $('#btnDelete').onclick = onDeleteProduct;
      $('#btnUpload').onclick = onUpload;

      $('#btnLogout').onclick = ()=>{
        localStorage.removeItem('adminToken');
        location.href = '/admin-login.html';
      };
    })();
  </script>
</body>
</html>
