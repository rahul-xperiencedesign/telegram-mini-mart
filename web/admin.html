<script>
/** === Admin API bootstrap (Render + JWT) ===
 * Paste this block at the TOP of admin.html, before any other scripts.
 */
(function () {
  // 1) Your Render backend (no trailing slash)
  window.API_BASE = 'https://telegram-mini-mart.onrender.com';

  // Token storage key
  const TOKEN_KEY = 'adminToken';

  // 2) A small wrapper around fetch:
  //    - Prefix relative URLs with API_BASE
  //    - Attach Authorization: Bearer <token> if present
  const _origFetch = window.fetch.bind(window);
  window.fetch = async (input, init = {}) => {
    let url = input;
    if (typeof input === 'string' && input.startsWith('/')) {
      url = API_BASE + input;
    }
    const headers = new Headers(init.headers || {});
    const token = localStorage.getItem(TOKEN_KEY);
    if (token && !headers.has('Authorization')) {
      headers.set('Authorization', 'Bearer ' + token);
    }
    return _origFetch(url, { ...init, headers });
  };

  // 3) Session helpers
  async function verifySession() {
    try {
      const r = await fetch('/admin/auth/session', { method: 'GET' });
      return r.ok;
    } catch {
      return false;
    }
  }

  async function doLoginPrompt() {
    const email = prompt('Admin email (Render env ADMIN_EMAIL):', '');
    const password = prompt('Admin password (Render env ADMIN_PASSWORD):', '');
    if (!email || !password) throw new Error('Login cancelled');

    const resp = await fetch('/admin/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    let json = {};
    try { json = await resp.json(); } catch { /* ignore */ }

    if (!resp.ok || !json.ok || !json.token) {
      console.warn('Login failed:', json);
      throw new Error(json.error || 'Login failed');
    }
    localStorage.setItem(TOKEN_KEY, json.token);

    // Double-check token works
    const ok = await verifySession();
    if (!ok) {
      localStorage.removeItem(TOKEN_KEY);
      throw new Error('Token verify failed after login');
    }
  }

  async function ensureSession() {
    // If a token exists, try to verify it; otherwise, prompt login
    const hasToken = !!localStorage.getItem(TOKEN_KEY);
    if (hasToken) {
      const ok = await verifySession();
      if (ok) return;
      // token invalid/expired -> clear and fallthrough to prompt
      localStorage.removeItem(TOKEN_KEY);
    }
    await doLoginPrompt().catch((err) => {
      console.warn(err);
      alert('Admin login required to use this page.');
      throw err;
    });
  }

  function logout() {
    localStorage.removeItem(TOKEN_KEY);
    location.reload();
  }

  // 4) Expose helpers (optional, handy in DevTools)
  window.ADMIN = {
    login: () => doLoginPrompt().then(() => location.reload()),
    logout,
    apiBase: () => window.API_BASE
  };

  // 5) Bind a generic logout click (if a button exists)
  document.addEventListener('click', (ev) => {
    const el = ev.target.closest('[data-logout], #logout, .logout-button');
    if (!el) return;
    ev.preventDefault();
    logout();
  });

  // 6) Start: make sure we have a valid session before the pageâ€™s own scripts run
  //    If you prefer an explicit "Log in" button, comment the line below
  ensureSession().catch(() => {/* stop page init if not logged in */});
})();
</script>
